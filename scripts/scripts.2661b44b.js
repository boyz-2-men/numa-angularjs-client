"use strict";angular.module("warriorPoetsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngMessages","Satellizer","mgcrea.ngStrap","angularSpinner","ui.bootstrap.tpls","ui.bootstrap.collapse","ui.bootstrap.dropdown","ui.bootstrap.tabs","plangular","contenteditable","angularFileUpload","wu.masonry","matchmedia-ng"]).config(["$routeProvider","$httpProvider","$authProvider","$locationProvider","$popoverProvider","$tooltipProvider","$modalProvider",function(a,b,c,d,e,f,g){c.github({clientId:"a6cf7f2af1739f24601f"}),c.google({clientId:"636774587721-nmkg52cbr188p3rpjda5l0jlndq3ngb0.apps.googleusercontent.com"}),c.facebook({clientId:"551613144966753"}),a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/logout",{template:null,controller:"LogoutCtrl"}).when("/signup",{templateUrl:"views/signup.html",controller:"SignupCtrl"}).when("/user/:id",{templateUrl:"views/profile.html",controller:"ProfileCtrl"}).when("/forgot",{templateUrl:"views/forgot.html",controller:"ForgotCtrl"}).when("/reset",{templateUrl:"views/reset.html",controller:"ResetCtrl"}).when("/poem/:id",{templateUrl:"views/poem.html",controller:"PoemCtrl"}).when("/poem/:id/comments",{templateUrl:"views/comments.html",controller:"CommentsCtrl"}).when("/feed",{templateUrl:"views/feed.html",controller:"FeedCtrl"}).when("/create",{templateUrl:"views/create.html",controller:"CreateCtrl"}).when("/edit/:id",{templateUrl:"views/edit.html",controller:"EditCtrl"}).otherwise({redirectTo:"/"}),b.interceptors.push("tokenInterceptorFactory"),angular.extend(e.defaults,{html:!0}),angular.extend(f.defaults,{html:!0}),angular.extend(g.defaults,{html:!0}),d.hashPrefix("!")}]),angular.module("warriorPoetsApp").controller("MainCtrl",["$scope","storageFactory","userFactory",function(a,b,c){var d=b.getId();c.init(d,"Basic"),a.isLoggedIn=function(){var a=b.getToken(),c=b.getId();return a&&c?!0:!1}}]),angular.module("warriorPoetsApp").controller("AboutCtrl",["$scope",function(){}]),angular.module("warriorPoetsApp").controller("LoginCtrl",["$location","$scope","helperFactory","userFactory","storageFactory","$auth","$alert","$resource","$http","$rootScope","usSpinnerService","$q","$sce","$tooltip",function(a,b,c,d,e,f,g,h,i,j,k){b.popover={title:"Protect your privacy",content:"If you close your browser without logging out, we'll store an access token to remember you.<br />Other people who use this computer will also be able to log in as you.",checked:!1};var l=!1;"expired"===a.search().session&&(b.err="Session expired. Please login again",l=!0),b.go=c.go,b.authenticate=function(b){k.spin("login-spinner"),"reddit"===b?(i({method:"POST",url:"https://ssl.reddit.com/api/v1/authorize",data:{client_id:"QWgNmA7jVv4KWA",response_type:"code",state:"Random_String",redirect_uri:window.location.origin,duration:"temporary",scope:"identity"}}).success(function(a){console.log("SUC:",a)}).error(function(a){console.log("ERR:",a)}),k.stop("login-spinner")):f.authenticate(b).then(function(a){g({type:"material",dismissable:!1,duration:5,placement:top,title:"Hello, "+a.data.displayName+"!",content:"You have successfully logged in."}),console.log("RES:",a),d.setInfo(a.data.id,a.data.displayName),e.setId(a.data.id),j.displayName=a.data.displayName,k.stop("login-spinner"),j.$emit("login")}).catch(function(b){0===b.status?f.logout().then(function(){g({type:"material-err",title:"We've lost connection to our backend.",content:"Please try logging back in. If the problem persists, try again later.",duration:6,dismissable:!0})}):g({type:"material-err",dismissable:!0,title:"Oops! ",content:b.data.message,duration:5}),e.deleteId(),e.deleteToken(),k.stop("login-spinner"),a.path("/login")})},b.login=function(){k.spin("login-spinner");var c={};c.displayName=b.displayName,c.password=b.password,c.stayLoggedIn=b.stayLoggedIn,console.log("REQ:",c);var h=d.rLogin(c);h.$promise.then(function(b){g({type:"material",dismissable:!1,duration:5,placement:top,title:"Hello, "+c.displayName+"!",content:"You have successfully logged in."}),d.setInfo(b.id,c.displayName),e.setId(b.id),e.setToken(b.token),a.path("/"),j.displayName=c.displayName,j.isAuthenticated=!0,k.stop("login-spinner"),j.$emit("login")},function(b){0===b.status?f.logout().then(function(){g({type:"material-err",title:"We've lost connection to our backend.",content:"Please try logging back in. If the problem persists, try again later.",duration:6,dismissable:!0})}):g({type:"material-err",dismissable:!0,title:"Oops! ",content:b.data.message,duration:5}),e.deleteId(),e.deleteToken(),k.stop("login-spinner"),a.path("/login")})}}]),angular.module("warriorPoetsApp").controller("SignupCtrl",["$location","$scope","helperFactory","userFactory","storageFactory","$alert","$rootScope","usSpinnerService","$q","$sce","$tooltip",function(a,b,c,d,e,f,g,h){b.popover={title:"Protect your privacy",content:"If you close your browser without logging out, we'll store an access token to remember you.<br />Other people who use this computer will also be able to log in as you.",checked:!1},b.go=c.go,b.signUp=function(){h.spin("signup-spinner");var c={};c.displayName=b.displayName,c.password=b.password,c.stayLoggedIn=b.stayLoggedIn,console.log("REQ:",c);var i=d.rSignUp(c);i.$promise.then(function(b){f({type:"material",dismissable:!1,duration:5,placement:top,title:"Hello, "+c.displayName+"!",content:"You have successfully signed up."}),console.log("RES:",b),d.setInfo(b.id,c.displayName),e.setId(b.id),e.setToken(b.token),a.path("/"),g.displayName=c.displayName,g.isAuthenticated=!0,h.stop("signup-spinner")},function(a){f({type:"material-err",dismissable:!0,title:"Oops! ",content:a.data.message,duration:5}),h.stop("signup-spinner")})}}]),angular.module("warriorPoetsApp").controller("ProfileCtrl",["$scope","userFactory","$alert","storageFactory","$location","$rootScope","$upload","$routeParams","$tooltip",function(a,b,c,d,e,f,g,h){a.currentUser=d.getId(),a.userToView=h.id,b.init(h.id,"Full");var i=f.$on("finishedSettingUserDataOnPageRefresh",function(){a.displayName=b.getDisplayName(),a.email=b.getEmail(),a.joinedDate=b.getJoinedDate(),a.avatarUrl=b.getAvatarUrl(),a.poems=b.getPoems()});a.$on("$destroy",function(){i()}),a.modal={title:"Are you sure?"},a.tooltip={title:"Change your avatar",checked:!1},a.tabs=[{title:"Poems"},{title:"Comments"}],a.creds={bucketName:"numa-temp",accessKeyId:"AKIAIQXDLJ23NA3YRHCQ",secretAccessKey:"nQtlkK9Re9OTIZuOQDexdP26b3BKPzQpQSKZrldf"},a.editorEnabled=!1,a.sizeLimit=5292880,a.uploading=!1,a.go=function(a,b){e.path(a+"/"+b)},a.fileSizeLabel=function(){return Math.round(a.sizeLimit/1024/1024)+" MB"},a.uniqueString=function(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;8>c;++c)a+=b.charAt(Math.floor(Math.random()*b.length));return a},a.upload=function(){a.uploading=!0,a.uploadProgress=0,AWS.config.update({accessKeyId:a.creds.accessKeyId,secretAccessKey:a.creds.secretAccessKey}),AWS.config.region="us-west-1";var d=new AWS.S3({params:{Bucket:a.creds.bucketName}});if(a.file){if("image/png"!==a.file.type&&"image/jpeg"!==a.file.type)return c({type:"material-err",dismissable:!0,title:"Oops! ",content:"Only PNG and JPEG types are accepted.",duration:5}),void(a.uploading=!1);var e=Math.round(parseInt(a.file.size));if(e>a.sizeLimit)return c({type:"material-err",dismissable:!0,title:"Oops! ",content:"Maximum file size is 5 MB. Your image is "+a.fileSizeLabel()+". Please upload a smaller image.",duration:5}),void(a.uploading=!1);var f=a.uniqueString()+"-"+a.file.name,g={Key:f,ContentType:a.file.type,Body:a.file,ServerSideEncryption:"AES256"};d.putObject(g,function(d){if(d)return c({type:"material-err",dismissable:!0,title:"Oops! ",content:"Please try again.",duration:5}),console.log(d.code,d.message),void(a.uploading=!1);var e={};e.fileName=f;var g=b.rSaveAvatarUrl(e);g.$promise.then(function(b){c({type:"material",dismissable:!0,title:"Success! ",content:"Profile pic updated.",duration:5}),a.avatarUrl=b.avatarUrl,console.log(b),a.uploading=!1},function(b){console.log(b),a.uploading=!1})}).on("httpUploadProgress",function(a){console.log("percent completed:",Math.round(a.loaded/a.total*100))})}else c({type:"material-err",dismissable:!0,title:"Oops! ",content:"Please select an image to upload.",duration:5}),a.uploading=!1},a.onFileSelect=function(d){return a.uploading=!0,angular.isArray(d)&&(d=d[0]),"image/png"!==d.type&&"image/jpeg"!==d.type?(c({type:"material-err",dismissable:!0,title:"Oops! ",content:"Only PNG and JPEG types are accepted.",duration:5}),void(a.uploading=!1)):void(a.upload=g.upload({url:"http://localhost:3000/api/v1/user/"+b.getId()+"/avatar",method:"POST",file:d}).progress(function(a){console.log("percent completed:",parseInt(100*a.loaded/a.total))}).success(function(b){console.log(b),c({type:"material",dismissable:!0,title:"Success! ",content:"Profile pic updated.",duration:5}),a.avatarUrl=b.avatarUrl,a.uploading=!1}).error(function(b){console.log("Error uploading file: "+b.message||b),a.uploading=!1}))},a.enableEditor=function(){a.editorEnabled=!0},a.disableEditor=function(){a.editorEnabled=!1},a.save=function(){var d={};d.email=a.email,console.log("req:",d);var e=b.hUpdateUser(d);e.then(function(b){console.log("good res:",b),a.editorEnabled=!1,a.email=b.data.user.email,c({type:"material",dismissable:!1,duration:5,placement:top,content:"You have successfully updated your profile."})},function(a){c({type:"material-err",dismissable:!0,title:"Oops! ",content:a.data.message,duration:5})})},a.deleteAccount=function(){var a=b.rDeleteAccount();a.$promise.then(function(){c({type:"material",dismissable:!1,duration:5,placement:top,content:"You have successfully deleted your account."}),d.deleteId(),d.deleteToken(),b.deleteInfo(),e.path("/"),f.isAuthenticated=!1},function(a){c({type:"material-err",dismissable:!0,title:"Oops! ",content:a.data.message,duration:5})})}}]),angular.module("warriorPoetsApp").controller("LogoutCtrl",["$auth","$alert","storageFactory","userFactory","$rootScope",function(a,b,c,d,e){a.logout().then(function(){b({type:"material",title:"You have been logged out!",content:"Now fuck off, mate.",duration:4,dismissable:!1}),c.deleteId(),c.deleteToken(),d.deleteInfo(),e.$emit("logout")})}]),angular.module("warriorPoetsApp").controller("NavbarCtrl",["$scope","storageFactory","$rootScope","userFactory","$tooltip","matchmedia",function(a,b,c,d,e,f){a.onPhone=!1,a.isCollapsed=!0,a.tooltipCreate={title:"Create a poem.",checked:!1},a.tooltipFeed={title:"View the poem feed.",checked:!1};var g=c.$on("finishedSettingUserDataOnPageRefresh",function(){a.id=b.getId(),a.avatarUrl=d.getAvatarUrl()}),h=c.$on("login",function(){a.id=b.getId(),a.avatarUrl=d.getAvatarUrl()}),i=c.$on("logout",function(){a.id=void 0,a.avatarUrl=void 0}),j=f.onPhone(function(){a.onPhone=!a.onPhone});a.$on("$destroy",function(){h(),i(),g(),j()}),a.collapse=function(){a.isCollapsed=!a.isCollapsed}}]),angular.module("warriorPoetsApp").controller("ForgotCtrl",["$scope","$resource","endpointConstants","$alert","$location",function(a,b,c,d,e){a.resetPassword=function(){var f={};f.email=a.email;var g=b(c.forgotPassword).save(f);g.$promise.then(function(a){d({type:"material",dismissable:!1,duration:5,placement:top,content:"An email has been sent to you with further instructions."}),console.log("RES:",a),e.path("/")},function(a){d({type:"material-err",dismissable:!0,title:"Oops! ",content:a.data.message,duration:5}),console.log("RES:",a)})}}]),angular.module("warriorPoetsApp").controller("ResetCtrl",["$scope","$alert","$location","$resource","endpointConstants","usSpinnerService",function(a,b,c,d,e,f){var g=c.search().token;a.reset=function(){if(g){f.spin("resetPassword-spinner");var h=d(e.resetPassword,{token:g}).get();h.$promise.then(function(){a.userExists=!0},function(){f.stop("resetPassword-spinner"),b({type:"material-err",dismissable:!0,title:"Oops! ",content:"Looks like your reset token expired and/or the specified user does not exists. Please request to reset your password again.",duration:6}),c.url(c.path()),c.path("/forgot")})}else f.stop("resetPassword-spinner"),b({type:"material-err",dismissable:!0,title:"Oops! ",content:"Please follow the link in the email we sent you to reset your password.",duration:5}),c.url(c.path()),c.path("/")},a.reset(),a.updatePassword=function(){if(g){f.spin("resetPassword-spinner");var h={};h.password=a.password;var i=d(e.resetPassword,{token:g}).save([],h);i.$promise.then(function(){f.stop("resetPassword-spinner"),b({type:"material",dismissable:!1,duration:5,placement:top,title:"Success!",content:"Your password has been changed."}),c.path("/login")},function(){f.stop("resetPassword-spinner"),b({type:"material-err",dismissable:!0,title:"Oops!",content:"Please try again. If the problem persists please request to reset your password again.",duration:5})})}else f.stop("resetPassword-spinner"),b({type:"material-err",dismissable:!0,title:"Oops!",content:"Looks like your reset token expired and/or the specified user does not exists. Please request to reset your password again.",duration:6}),c.url(c.path()),c.path("/")}}]),angular.module("warriorPoetsApp").controller("PoemCtrl",["$scope","$routeParams","poemFactory","storageFactory","userFactory","$location",function(a,b,c,d,e,f){a.userId=d.getId(),e.init(a.userId,"Basic");var g=b.id;if(g){var h=c.get(g);h.$promise.then(function(b){a.creatorId=b.creator.id,a.title=b.poem.title,a.poem=b.poem.poem},function(a){console.log(a)})}a.go=function(a){f.path(a+"/"+g)}}]),angular.module("warriorPoetsApp").controller("CommentsCtrl",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("warriorPoetsApp").controller("FeedCtrl",function(){}),angular.module("warriorPoetsApp").controller("CreateCtrl",["$scope","$resource","$alert","userFactory","$location","storageFactory",function(a,b,c,d,e,f){var g=f.getId();d.init(g,"Basic"),a.title="Untitled",a.savePoem=function(){var b={};b.poem=a.poem,b.title=a.title,console.log("req:",b);var g=d.rSavePoem(b);g.$promise.then(function(a){console.log("good res:",a),c({type:"material",dismissable:!1,duration:5,title:"Poem saved."});var b=f.getId();e.path("/user/"+b)},function(a){c({type:"material-err",dismissable:!0,title:"Oops! ",content:a.data.message,duration:5})})}}]),angular.module("warriorPoetsApp").controller("EditCtrl",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]});var serverDomain="http://localhost:3000",apiVersion="/api/v1";angular.module("warriorPoetsApp").constant("endpointConstants",{allUsers:serverDomain+apiVersion+"/user",userSignup:serverDomain+apiVersion+"/signup",userLogin:serverDomain+apiVersion+"/login",user:serverDomain+apiVersion+"/user/:id",forgotPassword:serverDomain+apiVersion+"/forgot",resetPassword:serverDomain+apiVersion+"/reset/:token",userAvatar:serverDomain+apiVersion+"/user/:id/avatar",userPoem:serverDomain+apiVersion+"/user/:id/poem",poem:serverDomain+apiVersion+"/poem/:id"}),angular.module("warriorPoetsApp").constant("storageConstants",{id:"id"}),angular.module("warriorPoetsApp").factory("storageFactory",["storageConstants","$cookieStore","$window",function(a,b,c){var d={};return d.setToken=function(a){c.localStorage.satellizer_token=a},d.setId=function(c){b.put(a.id,c)},d.getId=function(){return b.get(a.id)},d.getToken=function(){return c.localStorage.satellizer_token},d.deleteId=function(){b.remove(a.id)},d.deleteToken=function(){delete c.localStorage.satellizer_token},d}]),angular.module("warriorPoetsApp").factory("tokenInterceptorFactory",["$q","storageFactory",function(a,b){return{request:function(a){a.headers=a.headers||{};var c=b.getToken();return c&&(a.headers.Authorization="Bearer "+c),a},response:function(b){return b||a.when(b)}}}]),angular.module("warriorPoetsApp").factory("helperFactory",["$location","storageFactory","userFactory",function(a,b,c){return{go:function(b,c){console.log(c),a.path(b)},deleteDataAndRedirectToLogin:function(d){b.deleteId(),b.deleteToken(),c.deleteInfo(),a.path("/login").search("session","expired").search("previousView",d)}}}]),angular.module("warriorPoetsApp").factory("userFactory",["endpointConstants","$resource","storageFactory","$rootScope","$location","$auth","$alert","$http",function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n=[],o=c.getId(),p=c.getToken(),q=!1,r={},s="http://localhost:3000",t="/api/v1";return r.init=function(h,i){var j=c.getId();if(console.log("fetching and initializing user data"),h){var k={};k.type=i;var l=b(a.user,{id:h}).save(k);l.$promise.then(function(a){console.log(a),r.setInfo(a.id,a.displayName,a.joinedDate.split("T")[0],a.email,a.avatarUrl),j===h?(console.log("Viewing own profile"),d.displayName=a.displayName,d.isAuthenticated=!0):console.log("Viewing other user profile"),"Full"===i&&(console.log("NEED MORE TINGS"),r.setPoems(a.poems)),d.$emit("finishedSettingUserDataOnPageRefresh")},function(a){console.log("err:",a),0===a.status&&(f.logout().then(function(){g({type:"material-err",title:"We've lost connection to our backend.",content:"Please try logging back in",duration:4,dismissable:!0}),c.deleteId(),c.deleteToken(),r.deleteInfo()}),e.path("/login")),"token_expired"===a.data.type&&(f.logout().then(function(){g({type:"material-err",title:"Your session has expired!",content:"Please log back in to continue",duration:4,dismissable:!0}),c.deleteId(),c.deleteToken(),r.deleteInfo()}),e.path("/login"))})}else h||console.log("no params specified")},r.setInfo=function(a,b,c,d,e){i=a,j=b,k=c,l=d,m=e,q=!0},r.setIsLoggedIn=function(a){q=a},r.setId=function(a){i=a},r.setDisplayName=function(a){j=a},r.setJoinedDate=function(a){k=a},r.setEmail=function(a){l=a},r.setAvatarUrl=function(a){m=a},r.setPoems=function(a){n=a},r.getIsLoggedIn=function(){return q},r.getId=function(){return i},r.getDisplayName=function(){return j},r.getJoinedDate=function(){return k},r.getEmail=function(){return l},r.getAvatarUrl=function(){return m},r.getPoems=function(){return n},r.deleteInfo=function(){o=void 0,p=void 0,i=void 0,j=void 0,k=void 0,l=void 0,m=void 0,n=void 0,q=!1},r.rSignUp=function(c){return b(a.userSignup).save([],c)},r.rLogin=function(c){return b(a.userLogin).save([],c)},r.rLogout=function(){return b(a.userLogout).get()},r.rDeleteAccount=function(){return b(a.user,{id:o}).delete()},r.rGetUser=function(){return b(a.user,{id:o}).get()},r.rSaveAvatarUrl=function(d){var e=c.getId();return console.log(e),b(a.userAvatar,{id:e}).save([],d)},r.rSavePoem=function(d){return o=c.getId(),console.log(o),b(a.userPoem,{id:o}).save([],d)},r.hUpdateUser=function(a){var b=c.getId();return console.log(b),h({method:"PUT",url:s+t+"/user/"+b,data:{email:a.email}})},r}]),angular.module("warriorPoetsApp").factory("poemFactory",["$resource","endpointConstants",function(a,b){var c={};return c.get=function(c){return a(b.poem,{id:c}).get()},c}]),angular.module("warriorPoetsApp").directive("passwordStrength",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){var e=b.children(),f=Array.prototype.slice.call(e.children()),g=f.slice(-1)[0],h=f.slice(-2),i=f.slice(-3),j=f.slice(-4);b.after(e),b.bind("keyup",function(){angular.forEach(f,function(a){a.style.backgroundColor="#ebeef1"}),d.$modelValue&&(d.$modelValue.length>8?angular.forEach(j,function(a){a.style.backgroundColor="#008cdd"}):d.$modelValue.length>5?angular.forEach(i,function(a){a.style.backgroundColor="#6ead09"}):d.$modelValue.length>3?angular.forEach(h,function(a){a.style.backgroundColor="#e09115"}):g.style.backgroundColor="#e01414")})},template:'<span class="password-strength-indicator"><span></span><span></span><span></span><span></span></span>'}}),angular.module("warriorPoetsApp").directive("repeatPassword",function(){return{require:"ngModel",link:function(a,b,c,d){var e=b.inheritedData("$formController")[c.repeatPassword];d.$parsers.push(function(a){return a===e.$viewValue?(d.$setValidity("repeat",!0),a):void d.$setValidity("repeat",!1)}),e.$parsers.push(function(a){return d.$setValidity("repeat",a===d.$viewValue),a})}}}),angular.module("warriorPoetsApp").directive("file",function(){return{restrict:"AE",scope:{file:"@"},link:function(a,b){b.bind("change",function(b){var c=b.target.files,d=c[0];a.file=d,a.$parent.file=d,a.$apply()})}}});